---
date:           2021-03-16
category:       前端
title:          vite-1.0 CSS插件解读
tags:           [vite, 源代码]
---

这个`serverPluginCss`是用来处理CSS文件的，因为在vite里面CSS（包括SCSS这种预处理器）和JSON都被处理成JS module，然后再由HTML里面注入的`src/client/client.ts`来更新页面。
<!--more-->

## 正常的请求处理

![server-plugin-css-main](/assets/images/vite/server-plugin-css-main.png)

第28行用到的方法判断如下，就是简单的判断文件名：
![server-plugin-css-re](/assets/images/vite/server-plugin-css-re.png)
第32行的这个根据文件名生成哈希值就很有意思了，我在这里展开讲：[vite 1.0 HMR客户端][hmr-client]。

第34行的`processCSS`先跳过，下面再讲，简单来说就是生成CSS的，如果是裸的CSS其实是不需要处理的。但是如果是那些CSS预处理器，比如`stylus`，就需要先处理成CSS。

第38行的`codegenCss`就是把生成的CSS打包成JS module，这样客户端浏览器就可以直接执行这些代码，在这些代码里面，会更新CSS，具体更新过程会在[vite 1.0 HMR客户端][hmr-client]里面讲

第195行的`dataToEsm`是用的[Rollup](https://github.com/rollup/rollup)的功能，作用就是把数据转成ES Module，这样浏览器就能处理，就不详细介绍了，后面JSON文件的处理也是这么干的。

## processCSS

## 参考：

[A Quick Look at Constructable Stylesheets](https://dev.to/overrideveloper/a-first-look-at-constructable-stylesheets-3ae)
[What is the Shadow DOM?](https://bitsofco.de/what-is-the-shadow-dom)
[Constructable Stylesheet Objects](https://wicg.github.io/construct-stylesheets/)


[hmr-client]:/posts/2021-03-16-vite-1.0-HMR-client