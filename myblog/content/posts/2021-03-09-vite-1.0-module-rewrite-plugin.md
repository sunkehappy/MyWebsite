---
date:           2021-03-09
category:       前端
title:          vite-1.0模块重写文件解读
tags:           [vite, 源代码]
---

这个`serverPluginModuleRewrite`文件是vite 1.0里面非常重要的一个文件，我们需要仔细分析一下，整体结构如下：
<!--more-->
![serverPluginModuleRewrite.ts](/assets/images/vite/server-plugin-module-rewrite.png)

可以看到，除了红色箭头的地方，别的都很简单，我们展开这个`if`的代码块，发现它跟上一篇文章中的那个HTML插件一样，调用到了`rewriteImports`，用它的返回值作为`res`的`body`返回了。我们先看下它的参数：

## 参数
```jsx
  root: string,
  source: string,
  importer: string,
  resolver: InternalResolver,
  timestamp?: string
```
逐个分析下：
1. `root`是我们要打包的项目的根目录，比如我们要解析文件，肯定是要从根目录触发的
2. `source`这个就是文件的内容，当程序执行到这里的时候，我们一定是已经拿到文件内容了。第三方库(`node_modules`下面)是通过`serverPluginModuleResolve`解析的，非第三方库是通过`serverPluginServeStatic`来解析的。
3. `importer`指的是请求的url对应的文件。比如我在`main.jsx`中引入了`App.jsx`，那这里的`main.jsx`就是`importer`。
4. `resolver`是一个辅助我们用来解析的工具类，它可以把请求路径对应到文件，可以把文件对应到请求路径。
5. `timestamp`是一个可选参数，这个在HMR的时候会由客户端传过来一个时间，普通的请求里面不会有这个，在分析HMR的时候在看这个。

## 